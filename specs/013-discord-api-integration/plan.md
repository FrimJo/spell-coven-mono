# Implementation Plan: Discord API Integration for Remote MTG Play

**Branch**: `013-discord-api-integration` | **Date**: 2025-10-21 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/013-discord-api-integration/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command with reference to IMPLEMENTATION_GUIDE.md for technical decisions.

## Planning Status

- âœ… **Phase 0: Research** - Complete ([research.md](./research.md))
- âœ… **Phase 1: Design & Contracts** - Complete ([data-model.md](./data-model.md), [contracts/](./contracts/), [quickstart.md](./quickstart.md))
- âœ… **Phase 2: Task Generation** - Complete ([tasks.md](./tasks.md) - 180 tasks organized by user story)
- ðŸš€ **Ready for Implementation** - Run `/speckit.implement` or start with MVP (Setup + Foundational + US1 = 45 tasks)

## Summary

Integrate Discord's API to provide chat messaging and webcam streaming infrastructure for Spell Coven's remote MTG play platform. This leverages Discord's existing voice channels, video streaming, and text chat capabilities as the backend communication layer.

**Key Technical Approach**:
- **Authentication**: Discord OAuth2 with PKCE (Proof Key for Code Exchange) for secure client-side authentication without backend
- **Architecture**: Separation of Concerns - `@repo/discord-integration` package (pure Discord API logic) + `apps/web` (UI layer with React hooks/components)
- **Communication**: Discord Gateway (WebSocket) for real-time events + REST API for actions (messages, channels)
- **Video**: Discord RTC protocol for video streaming (HIGH RISK - may require fallback to custom WebRTC)
- **Phased Delivery**: 6 prioritized phases (P1-P6) for incremental value delivery

## Technical Context

<!--
  ACTION REQUIRED: Replace the content in this section with the technical details
  for the project. The structure here is presented in advisory capacity to guide
  the iteration process.
-->

**Language/Version**: TypeScript 5.x (React 18.x for UI, Node.js APIs for Discord package)  
**Primary Dependencies**: 
- `discord-api-types` - TypeScript type definitions for Discord API
- React 18.x - UI layer
- Native browser APIs - WebSocket (Gateway), fetch (REST), crypto (PKCE)
- Zod - Schema validation for data contracts

**Storage**: 
- Browser localStorage - OAuth tokens (with automatic refresh)
- IndexedDB - Message cache (optional for offline support)
- Discord servers - Persistent data (channels, messages, metadata)

**Testing**: Vitest (unit tests for `@repo/discord-integration`), Playwright (E2E for OAuth flow and UI)  
**Target Platform**: Modern browsers (Chrome 90+, Firefox 88+, Safari 14+) - requires WebSocket, crypto.subtle, localStorage  
**Project Type**: Web (monorepo with new package `@repo/discord-integration` + updates to `apps/web`)  

**Performance Goals**: 
- OAuth authentication: <10 seconds end-to-end
- Gateway connection: <5 seconds after auth
- Message latency: <1 second (receive), <2 seconds (send)
- Video stream start: <10 seconds
- Reconnection: <30 seconds after network failure

**Constraints**: 
- Browser-first: No backend required for core functionality (PKCE OAuth, client-side WebSocket/REST)
- Security: Client ID is public (safe to commit), no client secret in browser, PKCE for OAuth security
- Rate limits: Discord API rate limits (per-user for OAuth tokens, per-app for bot tokens)
- Video protocol: Discord RTC protocol may not be fully documented (high risk)

**Scale/Scope**: 
- 6 user stories (P1-P6 priority)
- 65 functional requirements across 4 phases
- 11 key entities (tokens, users, channels, messages, rooms, streams)
- 2 packages: new `@repo/discord-integration` + updates to `apps/web`
- Estimated 4-7 weeks for full implementation (Phase 1-4)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Browser-First Architecture âœ… PASS

**Compliance**: Full compliance with browser-first principles
- âœ… Core features run entirely client-side (OAuth with PKCE, WebSocket Gateway, REST API calls)
- âœ… Uses browser-native APIs (WebSocket, fetch, crypto.subtle for PKCE)
- âœ… No backend required for authentication or communication
- âœ… Self-hosting remains viable (users can create own Discord app with Client ID)
- âœ… Offline-capable after initial Discord connection (localStorage token persistence)

**Note**: Discord's infrastructure provides the "backend" (Gateway, REST API, RTC), but all client logic runs in browser.

### II. Data Contract Discipline âœ… PASS

**Compliance**: Strong data contract enforcement planned
- âœ… Token storage schema versioned (`{ accessToken, refreshToken, expiresAt, version: "1.0" }`)
- âœ… Room metadata schema versioned (`{ version: "1.0", format, powerLevel, maxPlayers, createdAt }`)
- âœ… Game event schema versioned (`{ version: "1.0", type, data, timestamp }`)
- âœ… Validation planned with Zod for all schemas
- âœ… Error handling for contract violations (version mismatches, missing fields)
- âœ… Discord API responses validated before processing (FR-058)

**Contracts to define in Phase 1**:
- `DiscordToken` schema (localStorage)
- `RoomMetadata` schema (Discord channel topic/pinned message)
- `GameEventEmbed` schema (Discord message embeds)
- Gateway event types (from `discord-api-types`)

### III. User-Centric Prioritization âœ… PASS

**Compliance**: Strong user-centric focus
- âœ… User stories prioritized by value (P1: Auth gate â†’ P6: Video streaming)
- âœ… Each story independently testable and delivers standalone value
- âœ… Performance targets user-perceived metrics (auth <10s, messages <1-2s, video start <10s)
- âœ… Success criteria measurable and user-focused (SC-001 through SC-026)
- âœ… Error messages provide clear actionable guidance (FR-060 through FR-065)

**User priority alignment**:
1. Accuracy/quality: Discord's proven infrastructure ensures reliability
2. Runtime performance: Targets set for auth, messaging, video latency
3. Resource efficiency: Minimal dependencies, browser-native APIs

### IV. Specification-Driven Development âœ… PASS

**Compliance**: Full specification created before implementation
- âœ… Complete `spec.md` with 6 user stories, 65 functional requirements, 26 success criteria
- âœ… Technology-agnostic requirements (describes WHAT, not HOW)
- âœ… Data contracts documented in Key Entities section
- âœ… Acceptance criteria testable and measurable
- âœ… Specification versioned in git with feature branch

**Next steps**: Phase 0 research will resolve technical unknowns, Phase 1 will generate detailed data contracts.

### V. Monorepo Package Isolation âœ… PASS

**Compliance**: Strong package isolation planned
- âœ… New `@repo/discord-integration` package with clear boundaries
- âœ… Package has zero React dependencies (pure Discord API logic)
- âœ… Package has zero browser storage dependencies (returns tokens to caller)
- âœ… UI layer (`apps/web`) consumes package via React hooks (bridge layer)
- âœ… State management separate from API clients (messageStore, roomStore, voiceStore)
- âœ… Types shared via `@repo/discord-integration/types` for contract enforcement

**Package structure**:
- `@repo/discord-integration`: OAuth client, Gateway client, REST client, RTC client (pure logic)
- `apps/web`: React hooks, UI components, stores (presentation + state management)

### VI. Performance Through Optimization, Not Complexity âœ… PASS

**Compliance**: Simple, optimized implementation
- âœ… Uses proven protocols (Discord OAuth2, WebSocket Gateway, REST API)
- âœ… Minimal abstractions (direct API clients, no complex frameworks)
- âœ… Leverages Discord's optimized infrastructure (no custom WebRTC signaling initially)
- âœ… Performance targets documented and measurable
- âœ… Complexity justified only where necessary (e.g., PKCE for security, SoC for testability)

**Optimization strategy**:
- PKCE OAuth: Industry-standard, secure, no backend needed
- WebSocket Gateway: Discord's optimized real-time protocol
- Message queuing: Simple rate limit handling with exponential backoff

### VII. Open Source and Community-Driven âœ… PASS

**Compliance**: Fully open and extensible
- âœ… All code open source (MIT license)
- âœ… Self-hosting supported (users create own Discord app)
- âœ… Documentation enables contribution (IMPLEMENTATION_GUIDE.md, spec.md, plan.md)
- âœ… Architecture extensible (SoC enables swapping Discord for other providers)
- âœ… Community feedback informs prioritization (phased approach allows iteration)

**Community enablement**:
- Clear SoC architecture enables independent package development
- Discord app setup documented in IMPLEMENTATION_GUIDE.md Phase 0
- Self-hosting option with custom Discord Client ID

### Gate Summary

**Status**: âœ… **ALL GATES PASS** - Proceed to Phase 0 Research

**No violations requiring justification**. The Discord integration aligns perfectly with all constitutional principles:
- Browser-first with no backend dependencies
- Strong data contracts with versioning
- User-centric prioritization and measurable success criteria
- Complete specification before implementation
- Clean package isolation with SoC
- Simple, proven protocols without unnecessary complexity
- Fully open source and self-hostable

## Project Structure

### Documentation (this feature)

```
specs/013-discord-api-integration/
â”œâ”€â”€ README.md            # Navigation and overview
â”œâ”€â”€ spec.md              # Feature specification (WHAT/WHY)
â”œâ”€â”€ IMPLEMENTATION_GUIDE.md  # Implementation reference (HOW)
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ checklists/
â”‚   â””â”€â”€ requirements.md  # Specification quality validation
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

**Structure Decision**: Monorepo web application with new package + updates to existing web app

This feature adds a new package (`@repo/discord-integration`) and updates the existing web app (`apps/web`). The package structure enforces Separation of Concerns (SoC) with clear boundaries between Discord API logic and UI layer.

```
packages/
â”œâ”€â”€ discord-integration/          # NEW PACKAGE - Pure Discord API logic
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â”‚   â”œâ”€â”€ DiscordOAuthClient.ts      # OAuth flow with PKCE (no localStorage)
â”‚   â”‚   â”‚   â”œâ”€â”€ DiscordGatewayClient.ts    # WebSocket Gateway (no React)
â”‚   â”‚   â”‚   â”œâ”€â”€ DiscordRestClient.ts       # REST API (no UI)
â”‚   â”‚   â”‚   â””â”€â”€ DiscordRtcClient.ts        # RTC protocol (no MediaStream)
â”‚   â”‚   â”œâ”€â”€ managers/
â”‚   â”‚   â”‚   â”œâ”€â”€ VoiceStateManager.ts       # Voice state tracking
â”‚   â”‚   â”‚   â””â”€â”€ VideoQualityAdapter.ts     # Quality management
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ formatters.ts              # Message formatting
â”‚   â”‚   â”‚   â””â”€â”€ validators.ts              # Schema validation (Zod)
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts                    # DiscordToken, DiscordUser, PKCEChallenge
â”‚   â”‚   â”‚   â”œâ”€â”€ gateway.ts                 # GatewayEvent, VoiceState
â”‚   â”‚   â”‚   â”œâ”€â”€ messages.ts                # Message, Embed schemas
â”‚   â”‚   â”‚   â””â”€â”€ rooms.ts                   # RoomMetadata, VoiceChannel
â”‚   â”‚   â””â”€â”€ index.ts                       # Public API exports
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ unit/                          # Unit tests (Vitest)
â”‚   â”‚   â”‚   â”œâ”€â”€ clients/
â”‚   â”‚   â”‚   â”œâ”€â”€ managers/
â”‚   â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â””â”€â”€ integration/                   # Integration tests
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ README.md
â”‚
â””â”€â”€ [existing packages: eslint-config, mtg-image-db, prettier, tailwind, typescript-config]

apps/
â””â”€â”€ web/                                   # UPDATES - UI layer only
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ config/
    â”‚   â”‚   â””â”€â”€ discord.ts                 # Read env vars, type-safe config
    â”‚   â”œâ”€â”€ hooks/                         # React hooks (bridge layer)
    â”‚   â”‚   â”œâ”€â”€ useDiscordAuth.ts          # Consumes DiscordOAuthClient
    â”‚   â”‚   â”œâ”€â”€ useDiscordConnection.ts    # Consumes DiscordGatewayClient
    â”‚   â”‚   â”œâ”€â”€ useDiscordMessages.ts      # Consumes DiscordRestClient
    â”‚   â”‚   â”œâ”€â”€ useDiscordVideo.ts         # Consumes DiscordRtcClient
    â”‚   â”‚   â””â”€â”€ useVideoStream.ts          # MediaStream API wrapper
    â”‚   â”œâ”€â”€ components/
    â”‚   â”‚   â””â”€â”€ discord/                   # NEW - Discord UI components
    â”‚   â”‚       â”œâ”€â”€ DiscordAuthModal.tsx   # Presentation only
    â”‚   â”‚       â”œâ”€â”€ DiscordLoginButton.tsx # Presentation only
    â”‚   â”‚       â”œâ”€â”€ DiscordUserProfile.tsx # Presentation only
    â”‚   â”‚       â”œâ”€â”€ ConnectionStatus.tsx   # Presentation only
    â”‚   â”‚       â”œâ”€â”€ ChannelSelector.tsx    # Presentation only
    â”‚   â”‚       â”œâ”€â”€ MessageList.tsx        # Presentation only
    â”‚   â”‚       â”œâ”€â”€ MessageInput.tsx       # Presentation only
    â”‚   â”‚       â”œâ”€â”€ MessageEmbed.tsx       # Presentation only
    â”‚   â”‚       â”œâ”€â”€ VoiceChannelSelector.tsx # Presentation only
    â”‚   â”‚       â”œâ”€â”€ RoomCreator.tsx        # Presentation only
    â”‚   â”‚       â”œâ”€â”€ PlayerList.tsx         # Presentation only
    â”‚   â”‚       â”œâ”€â”€ VideoGrid.tsx          # Presentation only
    â”‚   â”‚       â”œâ”€â”€ CameraSelector.tsx     # Presentation only
    â”‚   â”‚       â””â”€â”€ StreamControls.tsx     # Presentation only
    â”‚   â”œâ”€â”€ stores/                        # State management (separate from API)
    â”‚   â”‚   â”œâ”€â”€ messageStore.ts            # Message cache
    â”‚   â”‚   â”œâ”€â”€ roomStore.ts               # Room state
    â”‚   â”‚   â””â”€â”€ voiceStore.ts              # Voice state
    â”‚   â”œâ”€â”€ lib/
    â”‚   â”‚   â””â”€â”€ card-recognition/
    â”‚   â”‚       â””â”€â”€ VideoFrameAdapter.ts   # NEW - Adapter for Discord streams
    â”‚   â””â”€â”€ routes/
    â”‚       â””â”€â”€ auth/
    â”‚           â””â”€â”€ discord/
    â”‚               â””â”€â”€ callback.tsx       # NEW - OAuth callback handler
    â”œâ”€â”€ tests/
    â”‚   â””â”€â”€ e2e/                           # Playwright E2E tests
    â”‚       â”œâ”€â”€ discord-auth.spec.ts       # OAuth flow
    â”‚       â””â”€â”€ discord-messaging.spec.ts  # Text chat
    â”œâ”€â”€ .env.development                   # UPDATED - Add VITE_DISCORD_CLIENT_ID
    â””â”€â”€ package.json                       # UPDATED - Add @repo/discord-integration dependency
```

**Key SoC Principles Enforced**:
- `@repo/discord-integration` has ZERO React dependencies
- `@repo/discord-integration` has ZERO browser storage dependencies (returns tokens to caller)
- UI components NEVER import Discord clients directly
- React hooks are the ONLY bridge between UI and Discord API
- State management (stores) is separate from API clients
- Types are shared via `@repo/discord-integration/types` for contract enforcement

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No violations** - All constitutional principles are satisfied. No complexity justification required.
