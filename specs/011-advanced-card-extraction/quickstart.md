# Quickstart: Advanced Card Extraction

**Feature**: Advanced Card Extraction with Corner Refinement, Perspective Warp, and Temporal Optimization  
**Branch**: `011-advanced-card-extraction`  
**Date**: 2025-10-16

## Overview

This feature enhances the existing SlimSAM-based card detection system with advanced geometry processing to accurately extract MTG cards from webcam video at any angle.

## Prerequisites

- Node.js 18+ and pnpm installed
- Existing Spell Coven monorepo cloned
- Webcam access for testing
- Physical MTG cards for manual testing

## Setup

### 1. Install Dependencies

```bash
cd apps/web
pnpm install
```

This will install the new `opencv.js` dependency added to `package.json`.

### 2. Download OpenCV.js WASM Files

OpenCV.js requires WASM files to be served from the `public/` directory:

```bash
# Create opencv directory
mkdir -p apps/web/public/opencv

# Download OpenCV.js (version 4.8.0)
curl -L https://docs.opencv.org/4.8.0/opencv.js -o apps/web/public/opencv/opencv.js
```

**Note**: The file is ~8.5MB. It will be lazy-loaded on first card click.

### 3. Verify Existing SlimSAM Setup

The feature builds on the existing SlimSAM detector. Verify it's working:

```bash
pnpm dev
# Navigate to http://localhost:3000/game/[gameId]
# Click camera button and verify SlimSAM initializes
```

## Development Workflow

### File Structure

```
apps/web/src/lib/
├── detectors/
│   ├── slimsam-detector.ts          # MODIFY: Add corner refinement
│   ├── geometry/                    # NEW: Geometry utilities
│   │   ├── contours.ts              # Contour detection & quad extraction
│   │   ├── perspective.ts           # Homography & perspective warp
│   │   └── validation.ts            # Quad validation & aspect ratio
│   └── types.ts                     # MODIFY: Add CardQuad type
├── webcam.ts                        # MODIFY: Add frame buffering
└── opencv-loader.ts                 # NEW: Lazy OpenCV.js loading
```

### Implementation Order

Follow the task order in `tasks.md` (generated by `/speckit.tasks`):

1. **Phase 1 (P1 - Core Value)**:
   - OpenCV.js integration and lazy loading
   - Contour detection and quad extraction
   - Perspective warp to 384×384
   - Corner refinement in SlimSAMDetector

2. **Phase 2 (P2 - Quality Improvement)**:
   - Frame buffer implementation
   - Sharpness calculation (Laplacian variance)
   - Temporal optimization (select sharpest frame)

3. **Phase 3 (P3 - Robustness)**:
   - Adaptive ROI expansion
   - Edge case handling

### Running the Development Server

```bash
cd apps/web
pnpm dev
```

Navigate to `http://localhost:3000/game/[gameId]` and test with physical MTG cards.

## Testing

### Manual Testing Checklist

Test with physical MTG cards at various angles:

- [ ] Card held flat (0° angle) - should work as before
- [ ] Card at 15° angle - should extract with perspective correction
- [ ] Card at 30° angle - should extract with perspective correction
- [ ] Card at 45° angle - should extract with perspective correction
- [ ] Card partially occluded by fingers - should attempt extraction or fail gracefully
- [ ] Card in poor lighting - should use ROI expansion if needed
- [ ] Hand movement while clicking - should select sharper frame

### Automated Testing (Optional)

If implementing Playwright tests:

```bash
cd apps/web
pnpm test:e2e
```

Test file: `tests/e2e/card-extraction.spec.ts`

## Debugging

### Enable Verbose Logging

Add debug logs in key functions:

```typescript
// In geometry/contours.ts
console.log('[Contours] Detected quad:', quad)
console.log('[Contours] Aspect ratio:', aspectRatio)

// In geometry/perspective.ts
console.log('[Perspective] Homography matrix:', matrix)
console.log('[Perspective] Warped canvas:', canvas.toDataURL())

// In webcam.ts
console.log('[FrameBuffer] Current size:', buffer.size)
console.log('[FrameBuffer] Sharpest frame:', sharpestFrame.sharpness)
```

### Visualize Detected Quad

Draw the detected quad on the overlay canvas for debugging:

```typescript
// In SlimSAMDetector.detect()
if (quad) {
  const ctx = overlayCanvas.getContext('2d')!
  ctx.strokeStyle = 'lime'
  ctx.lineWidth = 3
  ctx.beginPath()
  ctx.moveTo(quad.topLeft.x, quad.topLeft.y)
  ctx.lineTo(quad.topRight.x, quad.topRight.y)
  ctx.lineTo(quad.bottomRight.x, quad.bottomRight.y)
  ctx.lineTo(quad.bottomLeft.x, quad.bottomLeft.y)
  ctx.closePath()
  ctx.stroke()
}
```

### Check OpenCV.js Loading

Verify OpenCV.js loads correctly:

```typescript
// In opencv-loader.ts
console.log('[OpenCV] Loading started')
console.log('[OpenCV] Loaded successfully:', cv.getBuildInformation())
```

### Inspect Frame Buffer

Log frame buffer state:

```typescript
// In webcam.ts
console.log('[FrameBuffer] Frames:', buffer.frames.map(f => ({
  timestamp: buffer.metadata.get(f)?.timestamp,
  sharpness: buffer.metadata.get(f)?.sharpness
})))
```

## Performance Monitoring

### Key Metrics

Monitor these performance indicators:

```typescript
// Extraction timing
const startTime = performance.now()
const result = await extractCard(...)
const duration = performance.now() - startTime
console.log('[Performance] Extraction took:', duration, 'ms')

// Target: <500ms total
// Breakdown:
// - Contour detection: 10-20ms
// - Perspective warp: 15-25ms
// - Sharpness calculation: 5-10ms per frame
```

### Memory Usage

Check memory usage in Chrome DevTools:

1. Open DevTools → Performance → Memory
2. Take heap snapshot before/after card extraction
3. Verify frame buffer stays at ~7MB
4. Check for memory leaks (run extraction 10+ times)

## Common Issues

### OpenCV.js Not Loading

**Symptom**: `cv is not defined` error

**Solution**:
- Verify `public/opencv/opencv.js` exists
- Check browser console for 404 errors
- Ensure lazy loader waits for `cv.onRuntimeInitialized`

### Quad Detection Fails

**Symptom**: No quad detected, falls back to bounding box

**Solution**:
- Check mask quality from SlimSAM
- Adjust `APPROX_POLY_EPSILON` (try 0.01 or 0.03)
- Verify card is fully visible in frame
- Check lighting conditions

### Perspective Warp Produces Distorted Image

**Symptom**: Warped card looks stretched or skewed

**Solution**:
- Verify quad points are in correct order (TL, TR, BR, BL)
- Check homography matrix is invertible
- Ensure source quad is convex

### Frame Buffer Memory Leak

**Symptom**: Memory usage grows over time

**Solution**:
- Verify circular buffer evicts old frames
- Check WeakMap cleanup
- Ensure canvas elements are dereferenced

## Code Quality

### Type Checking

Run TypeScript type checker frequently:

```bash
pnpm check-types
```

Fix any type errors immediately.

### Linting

Run ESLint to maintain code quality:

```bash
pnpm lint
```

Auto-fix issues:

```bash
pnpm lint --fix
```

### Formatting

Format code with Prettier:

```bash
pnpm format
```

## Documentation

### Inline Comments

Add JSDoc comments to all public functions:

```typescript
/**
 * Detects card quadrilateral from binary mask
 * @param mask - Binary mask from SlimSAM segmentation
 * @param roi - Region of interest for detection
 * @returns Detected quad or null if detection fails
 */
export function detectQuadFromMask(
  mask: cv.Mat,
  roi: ROI
): CardQuad | null {
  // Implementation
}
```

### Update README

After implementation, update `apps/web/README.md` with:
- New OpenCV.js dependency
- Performance characteristics
- Known limitations

## Next Steps

After completing implementation:

1. Run full test suite
2. Update specification if behavior differs
3. Create PR with detailed description
4. Request code review
5. Merge to main branch

## Resources

- [OpenCV.js Documentation](https://docs.opencv.org/4.8.0/d5/d10/tutorial_js_root.html)
- [Perspective Transformation Tutorial](https://docs.opencv.org/4.8.0/da/d6e/tutorial_py_geometric_transformations.html)
- [Contour Detection](https://docs.opencv.org/4.8.0/d4/d73/tutorial_py_contours_begin.html)
- [SlimSAM Paper](https://arxiv.org/abs/2312.05284)

## Support

For questions or issues:
- Check existing issues in GitHub repo
- Review specification: `specs/011-advanced-card-extraction/spec.md`
- Review implementation plan: `specs/011-advanced-card-extraction/plan.md`
- Review data model: `specs/011-advanced-card-extraction/data-model.md`
