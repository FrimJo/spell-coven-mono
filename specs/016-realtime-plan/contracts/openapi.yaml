openapi: 3.1.0
info:
  title: Discord Gateway Realtime Communications API
  version: 1.0.0
  description: |
    Contracts for TanStack Start server functions and SSE endpoint that proxy Discord Gateway commands/events.
servers:
  - url: https://spellcoven.example.com
paths:
  /api/stream:
    get:
      summary: Subscribe to realtime Discord events via Server-Sent Events
      operationId: subscribeSse
      responses:
        '200':
          description: Stream of `SseEvent` frames
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/SseEvent'
      security:
        - sessionAuth: []
  /api/send-message:
    post:
      summary: Send a Discord chat message through the gateway
      operationId: sendMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageInput'
      responses:
        '200':
          description: Acknowledgement of enqueue success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/AuthError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '502':
          $ref: '#/components/responses/GatewayError'
      security:
        - sessionAuth: []
  /api/add-reaction:
    post:
      summary: Add a reaction to a Discord message
      operationId: addReaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddReactionInput'
      responses:
        '200':
          description: Reaction command accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
        '400': { $ref: '#/components/responses/ValidationError' }
        '401': { $ref: '#/components/responses/AuthError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '429': { $ref: '#/components/responses/RateLimitError' }
        '502': { $ref: '#/components/responses/GatewayError' }
      security:
        - sessionAuth: []
  /api/typing-start:
    post:
      summary: Trigger Discord typing indicator
      operationId: typingStart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TypingStartInput'
      responses:
        '200':
          description: Typing command accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OkResponse'
        '400': { $ref: '#/components/responses/ValidationError' }
        '401': { $ref: '#/components/responses/AuthError' }
        '403': { $ref: '#/components/responses/ForbiddenError' }
        '429': { $ref: '#/components/responses/RateLimitError' }
        '502': { $ref: '#/components/responses/GatewayError' }
      security:
        - sessionAuth: []
components:
  securitySchemes:
    sessionAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    OkResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean
          const: true
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
    ValidationIssue:
      type: object
      required: [path, message]
      properties:
        path:
          type: array
          items:
            type: string
        message:
          type: string
    SendMessageInput:
      type: object
      required: [channelId, content]
      properties:
        channelId:
          type: string
          minLength: 1
        content:
          type: string
          minLength: 1
          maxLength: 2000
    AddReactionInput:
      type: object
      required: [channelId, messageId, emoji]
      properties:
        channelId:
          type: string
          minLength: 1
        messageId:
          type: string
          minLength: 1
        emoji:
          type: string
          minLength: 1
          description: Unicode emoji or Discord custom emoji syntax
    TypingStartInput:
      type: object
      required: [channelId]
      properties:
        channelId:
          type: string
          minLength: 1
    TraceMeta:
      type: object
      required: [traceId, sentAt]
      properties:
        traceId:
          type: string
        sentAt:
          type: string
          format: date-time
    GatewayEvent:
      type: object
      required: [version, type, data]
      properties:
        version:
          type: string
          example: '1.0'
        type:
          type: string
          enum: [ready, messageCreate, messageUpdate, messageDelete, voice.joined, voice.left, error]
        data:
          type: object
          additionalProperties: true
        meta:
          $ref: '#/components/schemas/TraceMeta'
    GatewayCommand:
      type: object
      required: [version, type, data]
      properties:
        version:
          type: string
          example: '1.0'
        type:
          type: string
          enum: [sendMessage, addReaction, typingStart]
        data:
          type: object
          additionalProperties: true
        meta:
          $ref: '#/components/schemas/TraceMeta'
    SseEvent:
      type: object
      required: [version, event, data]
      properties:
        version:
          type: string
          example: '1.0'
        event:
          type: string
          enum: [ready, messageCreate, messageUpdate, messageDelete, voice.joined, voice.left, error]
        data:
          type: object
          additionalProperties: true
  responses:
    ValidationError:
      description: Request payload failed validation
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/ErrorResponse'
              - type: object
                properties:
                  issues:
                    type: array
                    items:
                      $ref: '#/components/schemas/ValidationIssue'
    AuthError:
      description: Caller not authenticated
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ForbiddenError:
      description: Caller lacks `chat:write` role or channel permission
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    RateLimitError:
      description: Per-user or gateway rate limit exceeded
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/ErrorResponse'
              - type: object
                properties:
                  retryAfterMs:
                    type: integer
                    minimum: 0
    GatewayError:
      description: Gateway unavailable or returned error frame
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
