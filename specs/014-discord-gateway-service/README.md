# Feature 014: Discord Gateway Service

**Status**: Planning Complete
**Branch**: `014-discord-gateway-service`
**Version**: 1.0.0

## Overview

Implementation of a production-ready Discord Gateway integration for Spell Coven, enabling real-time voice channel management and event streaming. Discord provides the **required communication infrastructure** - room management, voice chat, and **video streaming** (players stream webcams showing board state). While card recognition runs locally in each browser, Discord is **essential** for players to see each other's boards.

The system consists of three components:

1. **Discord Gateway Worker** - Long-lived Node.js service maintaining persistent WebSocket connection to Discord
2. **TanStack Start Backend** - Public API with server routes for room management + WebSocket hub for client events
3. **Client Libraries** - Complete DiscordRestClient and DiscordRtcClient implementations

**Architectural Principle**: Per Constitution v1.2.0, separation of concerns between communication and intelligence:
- **Discord provides** (required): Room management, voice chat, **video streaming** (webcam for board state viewing), text chat
- **Browser provides** (local): Card recognition on Discord video streams (CLIP/FAISS), game state, game tools
- **Key architecture**: Players stream webcams through Discord voice channels. Each player's browser watches Discord video streams and runs card recognition locally. Discord = communication layer; Browser = intelligence layer.

## Documentation

### Planning Artifacts (Phase 0-1)

- **[spec.md](./spec.md)** - Feature specification with user stories, requirements, and acceptance criteria
- **[plan.md](./plan.md)** - Implementation plan with technical context and architecture decisions
- **[research.md](./research.md)** - Technical research and decision rationale
- **[data-model.md](./data-model.md)** - Data entities, message contracts, and state models (includes `selfVideo` flag for webcam streaming)
- **[quickstart.md](./quickstart.md)** - Quick start guide for local development (includes Discord video permissions setup)

### API Contracts

- **[contracts/rest-api.yaml](./contracts/rest-api.yaml)** - OpenAPI 3.0 specification for REST endpoints
- **[contracts/websocket-protocol.md](./contracts/websocket-protocol.md)** - WebSocket protocol specification

### Implementation (Phase 2)

- **[tasks.md](./tasks.md)** - Implementation tasks (generated by `/speckit.tasks`)

## Architecture

### Communication Layer (Discord - Room, Voice, Video, Chat)
```
Player A ──────────────────────────────────────────→ Discord Voice Channel
  │                                                         │
  │ • Video stream (webcam showing board state)            │
  │ • Voice chat                                            │
  │ • Receives other players' video/audio                   │
  │                                                         │
  └─────────────────────────────────────────────────────── Player B
                                                            Player C
                                                            Player D
```

### Backend Integration (Managing Discord Resources)
```
Browser (OAuth2+PKCE → JWT)
   ├─ POST /api/create-room      ───────────┐
   ├─ DELETE /api/end-room/:id             │
   └─ WS wss://app/ws  (events)            │
                                            ▼
         TanStack Start Backend (public)
         • Server routes verify JWT via JWKS
         • Discord REST (bot token; server-only)
         • WebSocket fan-out to clients
                                            ▲
                                            │ (HMAC-signed)
                 Discord Gateway Worker ────┘
                 • Persistent WS to Discord
                 • Posts events → /api/internal/events
```

### Core Gameplay (Browser-Side, Per Player)
```
Each Player's Browser:
  • Watches Discord video stream from other players
  • Runs card recognition (CLIP/FAISS) on video frames
  • Maintains local game state
  • Uses game tools (life counters, etc.)
```

**Key Architecture**:
- **Discord**: Handles ALL communication (room, voice, video, chat)
- **Browser**: Runs card recognition on Discord video streams locally
- **Backend**: Manages Discord resources (create/delete channels, event notifications)

## Key Features

### User Stories

1. **US1**: Create Discord voice channels for game sessions
2. **US2**: End Discord voice channels when sessions finish
3. **US3**: Receive real-time notifications for voice join/leave events
4. **US4**: Use DiscordRestClient for Discord REST API operations
5. **US5**: Use DiscordRtcClient for Discord voice/video streaming

**Note**: Discord provides the communication layer (room, voice, video, chat). Card recognition runs locally in each player's browser on the Discord video streams.

### Technical Highlights

- **OAuth2 + PKCE**: Secure browser authentication without client secret
- **HMAC-Signed Webhooks**: Secure worker → backend communication
- **JWT Verification via JWKS**: Stateless authentication with key rotation support
- **Single-Guild MVP**: Hardcoded PRIMARY_GUILD_ID with multi-guild-capable contracts
- **Separate Services**: Gateway worker survives backend deploys (no session flapping)

## Project Structure

### New Components

```
packages/discord-gateway-worker/     # NEW: Gateway worker service
├── src/
│   ├── gateway.ts                   # Discord Gateway WebSocket client
│   ├── hub-client.ts                # HTTP client for TanStack Start
│   └── types.ts                     # Event types and contracts
└── package.json

apps/web/app/                        # EXTEND: TanStack Start backend
├── routes/api/
│   ├── create-room.ts               # NEW: POST /api/create-room
│   ├── end-room.$channelId.ts       # NEW: DELETE /api/end-room/:channelId
│   ├── ws.ts                        # NEW: WebSocket endpoint
│   └── internal/events.ts           # NEW: POST /api/internal/events
└── server/
    ├── ws-manager.ts                # NEW: WebSocket registry + broadcast
    └── discord.ts                   # NEW: Discord REST helpers

packages/discord-integration/        # EXTEND: Client libraries
└── src/clients/
    ├── DiscordRestClient.ts         # IMPLEMENT: REST API operations
    └── DiscordRtcClient.ts          # IMPLEMENT: RTC voice/video
```

## Environment Configuration

### Gateway Worker

```bash
DISCORD_BOT_TOKEN=...
PRIMARY_GUILD_ID=123456789012345678
HUB_ENDPOINT=https://your-domain.com/api/internal/events
HUB_SECRET=change-me
```

### TanStack Start Backend

```bash
DISCORD_BOT_TOKEN=...
PRIMARY_GUILD_ID=123456789012345678
HUB_SECRET=change-me
JWT_ISSUER=https://your-auth.example.com
JWT_AUDIENCE=spell-coven-web
JWT_PUBLIC_JWK_URL=https://your-auth.example.com/.well-known/jwks.json
VITE_BASE_URL=https://your-web.app
```

## Quick Start

See [quickstart.md](./quickstart.md) for detailed setup instructions.

**TL;DR**:
```bash
# 1. Configure environment variables (see above)

# 2. Start gateway worker
cd packages/discord-gateway-worker
pnpm dev

# 3. Start TanStack Start backend
cd apps/web
pnpm dev

# 4. Test WebSocket connection
wscat -c ws://localhost:3000/api/ws
> {"type":"auth","token":"YOUR_JWT"}
```

## Constitution Compliance

All constitution checks passed ✅ (Constitution v1.2.0):

- **Browser-First Architecture**: Discord is optional social feature; core gameplay (card recognition, game tools) remains browser-first and works offline
- **Social Features**: Third-party services (Discord) used for room coordination, voice chat per Constitution v1.2.0 Section "Social Features and Communication"
- **Data Contract Discipline**: Versioned message envelopes, HMAC signatures, Zod validation
- **User-Centric Prioritization**: Enables social play with low latency (<100ms)
- **Specification-Driven Development**: Following comprehensive guide v2.2
- **Monorepo Package Isolation**: Clear boundaries via HTTP/WebSocket APIs
- **Performance Through Optimization**: Simple WebSocket fan-out, no complex infrastructure
- **Open Source and Community-Driven**: Self-hostable, clear documentation

## Next Steps

1. Run `/speckit.tasks` to generate implementation tasks
2. Run `/speckit.implement` to execute tasks
3. Test locally following quickstart guide
4. Deploy to production (Railway, Render, or self-hosted)

## References

- [spell-coven-gateway-realtime-guide_v2.2.md](../../spell-coven-gateway-realtime-guide_v2.2.md)
- [Discord Gateway Documentation](https://discord.com/developers/docs/topics/gateway)
- [Discord Voice Documentation](https://discord.com/developers/docs/topics/voice-connections)
- [TanStack Start Documentation](https://tanstack.com/start)
- [OAuth2 PKCE (RFC 7636)](https://datatracker.ietf.org/doc/html/rfc7636)
