# Spell Coven Agent Guide

## Purpose

This guide consolidates the most relevant operational knowledge for agents working in this repository. It distills the "You Might Not Need an Effect" memory notes and the active Specify rules so that day-to-day decisions stay aligned with the project direction.

## Repository Scope

- **Tech stack:** TypeScript 5.x, React 18+/19, Vite 7, Tailwind CSS 4.x, TanStack Router, Radix UI, Node.js 20+ build tooling, Transformers.js for browser ML workloads.
- **Supporting tooling:** Python 3.10+ (embedding/data pipelines), browser IndexedDB for model caching, FAISS index + JSONL metadata for offline assets.
- **Structure:** Primary packages live under `packages/` and `apps/`; shared scripts sit in `scripts/`.

## Coding Guidelines

1. **Prefer render-time derivations.** If a value is based solely on props or state, compute it inline during render instead of storing it in React state plus an Effect.
2. **Reserve Effects for external synchronization.** Only reach for `useEffect` (or similar hooks) when coordinating with systems outside React (e.g., DOM APIs, network requests, subscriptions). Keep each effect minimal and focused.
3. **Handle expensive calculations with `useMemo`.** When you need to memoize a pure computation, wrap it in `useMemo` tied to its dependencies instead of using an Effect and extra state.
4. **Reset state declaratively.** Use the `key` prop to remount components when wholesale state resets are required; for partial resets, derive the new state directly during render.
5. **Consolidate event-driven logic.** Move user-driven workflows into event handlers or shared helper functions so that notifications, navigation, and cascading updates occur within the initiating event, not post-render effects.
6. **Lift shared state.** When multiple components need coordinated data, lift the state to a common ancestor rather than syncing separate state slices via effects.
7. **Data fetching discipline.** Fetch data inside effects only when strictly necessary, guard against race conditions, and clean up subscriptions or async work on unmount.

## Tooling & Commands

- **Development environment:** Assume a dev server is already running; attempt to connect/use the existing instance before starting a new one.
- **Type checking:** `bun typecheck`
- **Lint (auto-fix):** `bun lint:fix`
- **Format (auto-fix):** `bun format:fix`
- **Run tests:** `bun test`

## Decision Checklist

Before adding an Effect, confirm all of the following:

- There is an external system interaction that cannot be handled during render or via event handlers.
- The logic cannot be expressed as a pure computation (`useMemo`/derived values) or through declarative state control (`key`, lifted state).
- Cleanup for subscriptions or async operations is implemented to avoid leaks or race conditions.
- Can some code be moved into a `useEffectEvent` (React 19.2) to replace `useRef`, or `use` to replace awaiting promises in `useEffect`.

## When in Doubt

- Prefer declarative solutions and composition over imperative patches.
- Keep Effects rare, focused, and justified by external dependencies.
- Align with the active technology matrix above when choosing libraries, language features, or runtime assumptions.

## Cursor Cloud specific instructions

### Runtime versions

- **Node.js ~22.20** (managed via nvm; `.nvmrc` pins `22.20`).
- **Bun ^1.3.8** (primary package manager and script runner). Installed to `~/.bun/bin/bun`.

### Starting the dev server

Run from the repo root or `apps/web`:

```sh
cd apps/web && bun run with-env -- vite dev
```

The Vite dev server starts on **https://localhost:1234** with a self-signed HTTPS cert generated by `vite-plugin-mkcert`. Accept the browser security warning when accessing it for the first time.

### Testing caveats

- **`bun test` (root-level)** invokes Bun's built-in test runner and incorrectly picks up Playwright `.spec.ts` files, causing failures. Use **`bunx turbo run test`** instead, which runs vitest only on `*.test.ts(x)` files.
- There are currently no vitest unit test files, so `bunx turbo run test` will exit with code 1 (no tests found). This is the expected state of the repo.
- Playwright e2e tests require a running dev server, a Convex preview backend, and `bunx playwright install --with-deps chromium`. They are **not** runnable without a `CONVEX_DEPLOY_KEY` secret.

### Authentication

The app uses Discord OAuth via Convex. Without Discord credentials you can still view the landing page and verify SSR/routing, but cannot log in or create game rooms.

### Backend (Convex)

The backend is fully hosted on Convex Cloud. No local database is needed. The production read-only endpoint (`VITE_CONVEX_URL`) is already committed in `.env.development`. Running `bun run convex:dev` (which starts a local Convex dev watcher) requires a `CONVEX_DEPLOYMENT` value in `.env.development.local` â€” this is not needed for front-end dev server work.
